#include "xc.inc"
GLOBAL _count_primes
PSECT mytext, local, class=CODE, reloc=2


_count_primes:
    MOVLB 0X02
    MOVFF 0X002, 0X200
    MOVFF 0X001, 0X201
    MOVFF 0X004, 0X202
    MOVFF 0X003, 0X203
    
    MOVFF 0X200, 0X210		    ; i_H
    MOVFF 0X201, 0X211		    ; i_L
    
    LOOP_COUNT:
	CALL is_prime
	MOVLW 0X01
	CPFSEQ 0X230
	GOTO NEXT
	INCF 0X241
	MOVLW 0X00
	ADDWFC 0X240

	NEXT:
	    BCF STATUS, 0
	    MOVLW 0X00
	    INCF 0X211
	    ADDWFC 0X210
	    MOVFF 0X202, WREG
	    CPFSEQ 0X210
	    GOTO LOOP_COUNT
	    MOVFF 0X203, WREG
	    CPFSGT 0X211
	    GOTO LOOP_COUNT
	    MOVFF 0X240, 0X002
	    MOVFF 0X241, 0X001
	    RETURN
	    

is_prime:
    MOVFF 0X210, 0X212		    ; i_H
    MOVFF 0X211, 0X213		    ; i_L
    MOVLW 0X00
    CPFSEQ 0X212
    GOTO CHECK_PRIME
    GOTO CHECK_I_L
    
    CHECK_I_L:
	MOVLW 0X01
	CPFSEQ 0X213
	GOTO CHECK_PRIME
	GOTO NOT_PRIME
    
    CHECK_PRIME:
	MOVLB 0X02
	MOVLW 0X00
	MOVWF 0X220		    ; j_H
	MOVLW 0X02		    
	MOVWF 0X221		    ; j_L
	MOVFF 0X220, WREG
	CPFSEQ 0X212
	GOTO TEMP
	MOVFF 0X221, WREG
	CPFSEQ 0X213
	GOTO TEMP
	GOTO IS_PRIME
	
	TEMP:
	    BTFSC 0X213, 0
	    GOTO LOOP
	    GOTO NOT_PRIME
	
	LOOP:
	    BCF STATUS, 2
	    BCF STATUS, 0
	    MOVFF 0X210, 0X212		    ; i_H
	    MOVFF 0X211, 0X213		    ; i_L
	    MINUS:
		MOVFF 0X221, WREG
		SUBWF 0X213
		MOVFF 0X220, WREG
		SUBWFB 0X212
		MOVLW 0X00
		CPFSEQ 0X212
		GOTO CHECK_IF_MINUS
		CPFSEQ 0X213
		GOTO CHECK_IF_MINUS
		GOTO NOT_PRIME
		
	    CHECK_IF_MINUS:
		MOVFF 0X212,WREG
		CPFSGT 0X220
		GOTO CHECK_IF_MINUS_L
		GOTO SKIP
	    CHECK_IF_MINUS_L:
		CPFSEQ 0X220
		GOTO MINUS
		MOVFF 0X213, WREG
		CPFSGT 0X221
		GOTO MINUS
		GOTO SKIP
		
	    SKIP:
		BCF STATUS, 0
		INCF 0X221
		BC J_H_INCF
		MOVFF 0X210, WREG
		CPFSEQ 0X220
		GOTO LOOP
		MOVFF 0X211, WREG
		CPFSEQ 0X221
		GOTO LOOP
		GOTO IS_PRIME
		J_H_INCF:
		    INCF 0X220
		    MOVFF 0X210, WREG
		    CPFSEQ 0X220
		    GOTO LOOP
		    MOVFF 0X211, WREG
		    CPFSEQ 0X221
		    GOTO LOOP
		    GOTO IS_PRIME
		    
IS_PRIME:
    MOVLW 0X01
    MOVWF 0X230
    RETURN
NOT_PRIME:
    MOVLW 0XFF
    MOVWF 0X230
    RETURN
