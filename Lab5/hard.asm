#include "xc.inc"
GLOBAL _mul_extended
PSECT mytext, local, class=CODE, reloc=2

_mul_extended:
    CLRF WREG
    MOVLB 0X02
    MOVFF 0X002, 0X200
    MOVFF 0X001, 0X201

    
    MOVFF 0X004, 0X210
    MOVFF 0X003, 0X211
    
    CHECK_N_POS:
	BCF STATUS, 2
	BTFSS 0X200, 7 ;如果bit7是1(負數)就跳過CHECK_M_POS，先取二補數
	GOTO CHECK_M_POS
	COMF 0X201
	COMF 0X200
	INCF 0X201
	BTFSC STATUS, 2
	INCF 0X200
	INCF 0X220 ;紀錄是負數
	
    CHECK_M_POS:
	BCF STATUS, 2
	BTFSS 0X210, 7
	GOTO MUL_UNSIGNED
	COMF 0X211 ;進行到這表示m是負的
	COMF 0X210
	INCF 0X211
	BTFSC STATUS, 2
	INCF 0X210
	XORLW 0X01 ;0x01放入WREG
	XORWF 0X220 ;
	
    MUL_UNSIGNED:
	CLRF 0X12
	CLRF 0X13
	CLRF 0X14
	CLRF 0X15
	
	MOVFF 0X201, WREG ;n低位乘m低位
	MULWF 0X211
	MOVFF PRODL, 0X212 ;結果放到0x212(最低位)跟0x213(次低位)
	MOVFF PRODH, 0X213
	
	MOVFF 0X200, WREG ;n高位乘m低位
	MULWF 0X211
	MOVFF PRODL, WREG
	ADDWF 0X213 ;加到次低位
	MOVFF PRODH, WREG 
	ADDWFC 0X214 ;連同carry加到次高位
	
	MOVFF 0X201, WREG ;n低位乘m高位
	MULWF 0X210
	MOVFF PRODL, WREG
	ADDWF 0X213 ;加到次低位
	MOVFF PRODH, WREG
	ADDWFC 0X214;連同carry加到次高位
	
	MOVFF 0X200, WREG 
	MULWF 0X210
	MOVFF PRODL, WREG
	ADDWF 0X214 ;加到次高位
	MOVFF PRODH, WREG
	ADDWFC 0X215;加到高位
	
	BTFSS 0X220, 0 ;檢查0x220的bit0，是0==>正，1==>負，1就跳過ANS準備做二補數
	GOTO ANS
	
	COMF 0X212
	COMF 0X213
	COMF 0X214
	COMF 0X215
	INCF 0X212
	BTFSC STATUS, 2
	INCF 0X213
	BTFSC STATUS, 2
	INCF 0X214
	BTFSC STATUS, 2
	INCF 0X215
	
	ANS:
	    MOVFF 0X212, 0X001
	    MOVFF 0X213, 0X002
	    MOVFF 0X214, 0X003
	    MOVFF 0X215, 0X004
	    RETURN


